<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Big+Shoulders:opsz,wght@10..72,100..900&display=swap"
      rel="stylesheet"
    />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
      body {
        margin: 0;
        padding: 0;
        background: #121212;
        color: #ffffff;
      }
      #messages {
        position: fixed;
        left: 0;
        top: 0;
        width: 100%;
        height: calc(100% - 60px);
        background: #121212;
        overflow-y: auto;
        padding: 15px;
        box-sizing: border-box;
        font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, Roboto, Oxygen, Ubuntu, sans-serif;
        font-size: 15px;
        line-height: 1.4;
        letter-spacing: 0.2px;
      }
      #sendMsg {
        position: fixed;
        left: 0;
        bottom: 0;
        width: 100%;
        height: 60px;
        background: #121212;
        padding: 10px 15px;
        box-sizing: border-box;
        display: flex;
        align-items: center;
        gap: 10px;
        border-top: 1px solid #222222;
      }
      #msgTxt {
        flex: 1;
        height: 40px;
        padding: 0 15px;
        font-size: 15px;
        background-color: #1e1e1e;
        color: #ffffff;
        font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        border: none;
        border-radius: 20px;
      }
      #msgTxt::placeholder {
        color: #666666;
      }
      #msgBtn {
        width: 40px;
        height: 40px;
        background-color: #4CAF50;
        color: white;
        border: none;
        border-radius: 50%;
        font-size: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
      }
      #msgBtn .material-icons {
        font-size: 20px;
      }
      .outer {
        width: 100%;
        margin-top: 8px;
        display: flex;
      }
      #inner {
        padding: 8px 12px;
        box-sizing: border-box;
        border-radius: 16px;
        font-size: 15px;
        max-width: 70%;
      }
      .me {
        background: #4CAF50;
        color: #ffffff;
        margin-left: auto;
      }
      .notMe {
        background: #1e1e1e;
        color: #ffffff;
      }
      #dltMsg {
        display: none;
      }
      .top-bar {
        background: #181818;  /* Changed from #121212 to a lighter shade */
        padding: 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #222222;
        font-family: 'Big Shoulders', sans-serif;
      }
      .logo {
        color: #4CAF50;
        font-size: 24px;
        font-weight: 800;
        letter-spacing: 1px;
      }
      .time {
        color: #ffffff;
        font-size: 18px;
        font-weight: 500;
      }
      #messages {
        top: 55px;  /* Adjusted to account for only the top bar */
        height: calc(100% - 115px);  /* Adjusted height */
      }
      .divider {
        width: 75%;
        height: 4px;
        background: #2a2a2a;
        margin: 0 auto;
        position: fixed;
        top: 53px;
        left: 50%;
        transform: translateX(-50%);
        border-radius: 2px;
      }
      .reply-reference {
        font-size: 13px;
        padding: 6px 10px;
        margin-bottom: 6px;
        background: rgba(255, 255, 255, 0.08);
        border-left: 3px solid #4CAF50;
        border-radius: 4px;
        font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        line-height: 1.3;
      }
      .reply-to {
        position: fixed;
        bottom: 60px;
        left: 0;
        width: 100%;
        padding: 12px 15px;
        background: #1e1e1e;
        border-top: 1px solid #222222;
        display: none;
        font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        font-size: 14px;
        line-height: 1.4;
      }
      .reply-close {
        float: right;
        cursor: pointer;
        color: #888888;
        margin-left: 12px;
        padding: 4px;
      }
      .message-content {
        cursor: pointer;
      }
    </style>
    <script>
      // Request notification permission when page loads
      document.addEventListener('DOMContentLoaded', function() {
          if (Notification.permission !== 'granted' && Notification.permission !== 'denied') {
              Notification.requestPermission();
          }
      });
    </script>
  </head>
<body>
    <div class="top-bar">
      <div class="logo">ðŸ’¬ ChatSphere</div>
      <div class="time" id="currentTime"></div>
    </div>
    <div class="divider"></div>
    <div id="messages"></div>

    <div id="replyContainer" class="reply-to">
      <span id="replyText"></span>
      <span class="reply-close material-icons" onclick="module.cancelReply()">close</span>
    </div>

    <div id="sendMsg">
      <input type="text" id="msgTxt" placeholder="Type a message" onkeydown="if(event.key === 'Enter') module.sendMsg()" />
      <button id="msgBtn" onclick="module.sendMsg()"><span class="material-icons">send</span></button>
    </div>
<script src="env.js"></script>
    <script>
      module = {};
      let replyingTo = null;

      // Add these functions to make reply work
      module.setReply = function(messageId, sender, content) {
        replyingTo = {
          messageId: messageId,
          sender: sender,
          content: content
        };
        document.getElementById('replyContainer').style.display = 'block';
        document.getElementById('replyText').innerHTML = `Replying to ${sender}: ${content}`;
      };

      module.cancelReply = function() {
        replyingTo = null;
        document.getElementById('replyContainer').style.display = 'none';
      };
    </script>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
      import {
        getDatabase,
        ref,
        set,
        remove,
        onChildAdded,
        onChildRemoved,
      } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";

      const firebaseConfig = window.env;
      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);

      // variables
      var msgTxt = document.getElementById("msgTxt");
      var sender;
      if (sessionStorage.getItem("sender")) {
        sender = sessionStorage.getItem("sender");
      } else {
        sender = prompt("PLEASE ENTER YOUR NAME");
        sessionStorage.setItem("sender", sender);
      }

      // TO SEND MESSAGES
      module.sendMsg = function sendMsg() {
        var msg = msgTxt.value;
        if (msg.trim() !== '') {
          var timestamp = new Date().getTime();
          set(ref(db, "messages/" + timestamp), {
            msg: msg,
            sender: sender,
            replyTo: replyingTo
          });
          msgTxt.value = "";
          module.cancelReply();
          messages.scrollTop = messages.scrollHeight;
        }
      };
      // TO RECEIVE MSG
      onChildAdded(ref(db, "messages"), (data) => {
        let replyHtml = '';
        if (data.val().replyTo) {
          replyHtml = `
            <div class="reply-reference">
              <small>${data.val().replyTo.sender}: ${data.val().replyTo.content}</small>
            </div>`;
        }

        const escapedMsg = data.val().msg
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");

        if (data.val().sender == sender) {
          messages.innerHTML +=
            `<div style='justify-content:end' class='outer' id="${data.key}">
              <div id='inner' class='me'>
                ${replyHtml}
                <small style='display:block;font-size:12px;opacity:0.8;margin-bottom:3px'>You</small>
                <div class="message-content" onclick="module.setReply('${data.key}', '${data.val().sender}', '${escapedMsg}')">${escapedMsg}</div>
              </div>
            </div>`;
        } else {
          messages.innerHTML +=
            `<div class='outer' id="${data.key}">
              <div id='inner' class='notMe'>
                ${replyHtml}
                <small style='display:block;font-size:12px;opacity:0.8;margin-bottom:3px'>${data.val().sender}</small>
                <div class="message-content" onclick="module.setReply('${data.key}', '${data.val().sender}', '${escapedMsg}')">${escapedMsg}</div>
              </div>
            </div>`;
        }
        messages.scrollTop = messages.scrollHeight;
      });
      // TO DELETE MSG
      module.dltMsg = function dltMsg(key) {
        remove(ref(db, "messages/" + key));
      };

      // WHEN MSG IS DELETED
      onChildRemoved(ref(db, "messages"), (data) => {
        var msgBox = document.getElementById(data.key);
        messages.removeChild(msgBox);
      });
    </script>
    <script>
      function updateTime() {
        const timeElement = document.getElementById('currentTime');
        const now = new Date();
        timeElement.textContent = now.toLocaleTimeString('en-US', { 
          hour: '2-digit', 
          minute: '2-digit',
          second: '2-digit'  // Added seconds for better real-time display
        });
      }
      // Initial call
      updateTime();
      // Update every second
      setInterval(updateTime, 1000);
    </script>
  </body>
</html>
