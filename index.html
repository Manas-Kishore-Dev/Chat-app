<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Big+Shoulders:opsz,wght@10..72,100..900&display=swap"
      rel="stylesheet"
    />

    <style>
      body {
        margin: 0;
        padding: 0;
        background: #121212;
        color: #ffffff;
      }
      #messages {
        position: fixed;
        left: 0;
        top: 0;
        width: 100%;
        height: calc(100% - 60px);
        background: #121212;
        overflow-y: auto;
        padding: 15px;
        box-sizing: border-box;
        font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        font-size: 15px;
      }
      #sendMsg {
        position: fixed;
        left: 0;
        bottom: 0;
        width: 100%;
        height: 60px;
        background: #121212;
        padding: 10px 15px;
        box-sizing: border-box;
        display: flex;
        align-items: center;
        gap: 10px;
        border-top: 1px solid #222222;
      }
      #msgTxt {
        flex: 1;
        height: 40px;
        padding: 0 15px;
        font-size: 15px;
        background-color: #1e1e1e;
        color: #ffffff;
        font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        border: none;
        border-radius: 20px;
      }
      #msgTxt::placeholder {
        color: #666666;
      }
      #msgBtn {
        width: 40px;
        height: 40px;
        background-color: #4CAF50;
        color: white;
        border: none;
        border-radius: 50%;
        font-size: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .outer {
        width: 100%;
        margin-top: 8px;
        display: flex;
      }
      #inner {
        padding: 8px 12px;
        box-sizing: border-box;
        border-radius: 16px;
        font-size: 15px;
        max-width: 70%;
      }
      .me {
        background: #4CAF50;
        color: #ffffff;
        margin-left: auto;
      }
      .notMe {
        background: #1e1e1e;
        color: #ffffff;
      }
      #dltMsg {
        display: none;
      }
    </style>
  </head>

  <body>
    <div style="background: #121212; padding: 10px 15px; display: flex; align-items: center; border-bottom: 1px solid #222222;">
      <span style="color: #ffffff; font-size: 20px; margin-right: 15px;">←</span>
      <span style="color: #888888; font-size: 14px;">mitch@gmail.com</span>
    </div>
    <div id="messages"></div>

    <div id="sendMsg">
      <input type="text" id="msgTxt" placeholder="Type a message" onkeydown="if(event.key === 'Enter') module.sendMsg()" />
      <button id="msgBtn" onclick="module.sendMsg()">↑</button>
    </div>

    <script>
      module = {};
    </script>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
      import {
        getDatabase,
        ref,
        set,
        remove,
        onChildAdded,
        onChildRemoved,
      } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";

      const firebaseConfig = {
        apiKey: "AIzaSyBCQpRAaUoUG4UyE4D9nVMHKh4fxz9uzoo",
        projectId: "chat-app-77771",
        storageBucket: "chat-app-77771.firebasestorage.app",
        messagingSenderId: "943621496980",
        authDomain: "chat-app-77771.firebaseapp.com",
        appId: "1:943621496980:web:a8d50488822243c7e11481",
      };

      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);

      // variables
      var msgTxt = document.getElementById("msgTxt");
      var sender;
      if (sessionStorage.getItem("sender")) {
        sender = sessionStorage.getItem("sender");
      } else {
        sender = prompt("PLEASE ENTER YOUR NAME");
        sessionStorage.setItem("sender", sender);
      }

      // TO SEND MESSAGES
      module.sendMsg = function sendMsg() {
        var msg = msgTxt.value;
        if (msg.trim() !== '') {  // Only send if message isn't empty
          var timestamp = new Date().getTime();
          set(ref(db, "messages/" + timestamp), {
            msg: msg,
            sender: sender,
          });
          msgTxt.value = "";
          // Auto scroll after sending
          messages.scrollTop = messages.scrollHeight;
        }
      };
      // TO RECEIVE MSG
      onChildAdded(ref(db, "messages"), (data) => {
        if (data.val().sender == sender) {
          messages.innerHTML +=
            "<div style='justify-content:end' class='outer' id=" +
            data.key +
            "><div id='inner' class='me'><small style='display:block;font-size:12px;opacity:0.8;margin-bottom:3px'>You</small>" +
            data.val().msg +
            "</div></div>";
        } else {
          messages.innerHTML +=
            "<div class='outer' id=" +
            data.key +
            "><div id='inner' class='notMe'><small style='display:block;font-size:12px;opacity:0.8;margin-bottom:3px'>" +
            data.val().sender +
            "</small>" +
            data.val().msg +
            "</div></div>";
        }
        // Auto scroll to latest message
        messages.scrollTop = messages.scrollHeight;
      });

      // TO DELETE MSG
      module.dltMsg = function dltMsg(key) {
        remove(ref(db, "messages/" + key));
      };

      // WHEN MSG IS DELETED
      onChildRemoved(ref(db, "messages"), (data) => {
        var msgBox = document.getElementById(data.key);
        messages.removeChild(msgBox);
      });
    </script>
  </body>
</html>
